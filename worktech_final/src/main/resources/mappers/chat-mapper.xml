<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="chatMapper">
	<select id="selectChatList" resultMap="chatRoomResultSet">
		SELECT CHATROOM_NO, CHAT_OPEN, CHAT_TITLE, CHAT_TYPE, P_URL, MSG_CONTENT, SEND_TIME, CHAT_LIST_NO, CHAT_MEMBER, CHAT_STATUS
		FROM CHATROOM
     		 LEFT JOIN CHAT_LIST USING(CHATROOM_NO)
     		 LEFT JOIN PROFILE ON (CHAT_MEMBER = M_NO)
    		 LEFT JOIN (SELECT *
       			  		FROM (SELECT MSG_CONTENT, SEND_TIME, CHATROOM_NO, ROW_NUMBER() OVER (PARTITION BY CHATROOM_NO ORDER BY SEND_TIME DESC, MSG_ID DESC) AS RECENT
         					  FROM CHAT_MSG CM)
       					WHERE RECENT = 1) USING(CHATROOM_NO)	 
    	WHERE CHATROOM_NO IN (SELECT CHATROOM_NO
                    		  FROM CHAT_LIST
							  WHERE CHAT_MEMBER = '100000')
			  AND CHAT_STATUS = 'Y'
		ORDER BY SEND_TIME DESC
	</select>
	
	<resultMap type="ChatRoom" id="chatRoomResultSet">
		<id column="CHATROOM_NO" property="chatRoomNo"/>
		<result column="CHAT_OPEN" property="chatOpenMem"/>
		<result column="CHAT_TITLE" property="chatTitle"/>
		<result column="CHAT_TYPE" property="chatType"/>
		<result column="MSG_CONTENT" property="recentMsg"/>
		<result column="SEND_TIME" property="sendTime"/>
		<result column="CHAT_STATUS" property="chatStatus"/>
		<collection property="gatheringList" resultMap="gatheringMemberResultSet" javaType="arrayList"/>		
	</resultMap>
	
	<resultMap type="GatheringMember" id="gatheringMemberResultSet">
		<id column="CHAT_LIST_NO" property="gatheringNo"/>
		<result column="CHATROOM_NO" property="chatRoomNo"/>
		<result column="CHAT_MEMBER" property="gatheringMember"/>
		<result column="P_URL" property="profileUrl"/>
	</resultMap>
	
	<select id="getChatDepartmentList" resultMap="departmentResultSet">
		select *
		from department
		where d_status = 'Y'
	</select>
	
	<resultMap type="Department" id="departmentResultSet">
		<id column="D_NO" property="dNo"/>
		<result column="D_NAME" property="dName"/>
		<result column="D_PARENT" property="dParent"/>
		<result column="D_DATE" property="dDate"/>
		<result column="D_STATUS" property="dStatus"/>
	</resultMap>
	
	<select id="selectDeptMember" resultMap="memberResultSet">
		select m_no, name, job_grade, d_name
		from member
			 join department using(d_no)
		where m_no != #{mNo}
			  and (d_no = #{dNo}
			  or d_no in (select d_no
			  			  from department
			  			  start with d_parent = #{dNo}
                          connect by prior d_no = d_parent))
		order by name
	</select>
	
	<resultMap type="Member" id="memberResultSet">
		<id column="m_no" property="mNo"/>
		<result column="name" property="name"/>
		<result column="job_grade" property="jobGrade"/>
		<result column="d_name" property="dName"/>
	</resultMap>
	
	<select id="selectMemberName" resultType="string" parameterType="java.util.ArrayList">
		select name || ' ' || job_grade
		from member
		where m_no in
		<foreach item="mNo" collection="list" open="(" separator="," close=")">
			#{mNo}
		</foreach>
	</select>
	
	<insert id="insertGroupChatroom">
		insert into chatroom
		values(SEQ_CHAT.NEXTVAL, #{chatOpen}, #{chatTitle}, DEFAULT, DEFAULT)
	</insert>
	
	<insert id="insertGroupChatList">
		insert into chat_list
		values(SEQ_LIST.NEXTVAL, SEQ_CHAT.CURRVAL, #{mNo}, DEFAULT)
	</insert>
	
	<select id="selectCreateChatRoom" resultMap="chatRoomResultSet2">
		select chatroom_no, chat_open, chat_title, chat_type, chat_status, chat_list_no, chat_member, name || ' ' || job_grade as chat_member_name, p_url
		from chatroom left join
		     chat_list using(chatroom_no) join
		     member on (chat_member = m_no) left join
		     profile using (m_no) 
		where chatroom_no = (select last_number
		                     from USER_SEQUENCES
		                     where sequence_name = 'SEQ_CHAT') - 1
		      and chat_status = 'Y'
	</select>
	
	<resultMap type="ChatRoom" id="chatRoomResultSet2">
		<id column="CHATROOM_NO" property="chatRoomNo"/>
		<result column="CHAT_OPEN" property="chatOpenMem"/>
		<result column="CHAT_TITLE" property="chatTitle"/>
		<result column="CHAT_TYPE" property="chatType"/>
		<result column="CHAT_STATUS" property="chatStatus"/>
		<collection property="gatheringList" resultMap="gatheringMemberResultSet2" javaType="arrayList"/>		
	</resultMap>
	
	<resultMap type="GatheringMember" id="gatheringMemberResultSet2">
		<id column="CHAT_LIST_NO" property="gatheringNo"/>
		<result column="CHATROOM_NO" property="chatRoomNo"/>
		<result column="CHAT_MEMBER" property="gatheringMember"/>
		<result column="chat_member_name" property="gatheringMemberName"/>
		<result column="P_URL" property="profileUrl"/>
	</resultMap>
	
	<select id="selectMessageList" resultMap="chatMessageResultSet">
		select msg_id, msg_content, send_time, read_yn, chatroom_no, chat_member, name || ' ' || job_grade as chat_member_name
		from chat_msg join
		     member on (chat_member = m_no) join
		     chatroom using(chatroom_no)
		where chatroom_no = #{chatRoomNo}
			  and chat_status = 'Y'
	</select>
	
	<resultMap type="ChatMessage" id="chatMessageResultSet">
		<id column="MSG_ID" property="msgId"/>
		<result column="MSG_CONTENT" property="msgContent"/>
		<result column="SEND_TIME" property="sendTime"/>
		<result column="READ_YN" property="readYN"/>
		<result column="CHATROOM_NO" property="chatRoomNo"/>
		<result column="CHAT_MEMBER" property="sendMember"/>
		<result column="chat_member_name" property="sendMemberName"/>
	</resultMap>
	
	<select id="getNotReadCount" resultType="_int">
		select count(chatroom_no)
		from chat_msg
		where chatroom_no = #{chatRoomNo}
		      and send_time > (select chat_readtime
			                   from chat_list
			                   where chat_member = #{mNo}
			                         and chatroom_no = #{chatRoomNo})
	</select>
	
</mapper>
